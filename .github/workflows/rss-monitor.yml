name: RSS Monitor with Gemini Analysis

on:
  # schedule:
  #   - cron: '0 * * * *'  # æ¯æ™‚0åˆ†ã«å®Ÿè¡Œï¼ˆ1æ™‚é–“é–“éš”ï¼‰
  workflow_dispatch:

concurrency:
  group: rss-monitor
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  # Job1: RSSå–å¾—ãƒ»å·®åˆ†æ¤œå‡º
  rss-trigger:
    runs-on: ubuntu-latest
    outputs:
      # æ–°ç€è¨˜äº‹ãŒã‚ã‚‹ã‹ã®çœŸå½å€¤
      has-new-articles: ${{ steps.detect-new.outputs.has-new-articles }}
      # æ–°ç€è¨˜äº‹ã®æ•°
      new-articles-count: ${{ steps.detect-new.outputs.new-articles-count }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install RSS parser
      run: npm install rss-parser

    - name: Fetch and detect new articles
      id: detect-new
      run: node scripts/rss-processor.js

    - name: Upload new articles data
      if: steps.detect-new.outputs.has-new-articles == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: new-articles
        path: new-articles.json

    - name: Upload cache file
      if: steps.detect-new.outputs.has-new-articles == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: rss-cache
        path: cache/rss-processed.json

    - name: Summary
      run: |
        echo "ğŸ” RSS Trigger Results:"
        echo "   New articles found: ${{ steps.detect-new.outputs.has-new-articles }}"
        echo "   Count: ${{ steps.detect-new.outputs.new-articles-count }}"
        if [ "${{ steps.detect-new.outputs.has-new-articles }}" = "true" ]; then
          echo "âœ… Proceeding to Gemini analysis job"
        else
          echo "â­ï¸  No new articles, skipping downstream jobs"
        fi

  # Job2: Geminiåˆ†æ + JSå‡¦ç† + Mergeï¼ˆn8nã®è¤‡æ•°ãƒãƒ¼ãƒ‰ã«å¯¾å¿œï¼‰
  gemini-analysis:
    runs-on: ubuntu-latest
    needs: rss-trigger
    if: needs.rss-trigger.outputs.has-new-articles == 'true'
    outputs:
      analyzed-count: ${{ steps.process.outputs.analyzed-count }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Download new articles data
      uses: actions/download-artifact@v4
      with:
        name: new-articles
        path: .

    - name: Analyze articles with Gemini CLI
      id: analyze
      uses: google-github-actions/run-gemini-cli@v0.1.12
      with:
        gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
        gemini_model: gemini-2.5-flash
        settings: |
          {
            "coreTools": [
              "run_shell_command(cat)"
            ],
            "output": { "format": "json" }
          }
        prompt: |
          ä»¥ä¸‹ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã€è¨˜äº‹ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

          run_shell_command(cat, "new-articles.json")

          å„è¨˜äº‹ã«ã¤ã„ã¦ï¼š
          - AIé–¢é€£ã‹AIä»¥å¤–ã‹ã‚’åˆ¤å®š
          - ç°¡æ½”ãªè¦ç´„ã‚’ä½œæˆ

          ä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
          {"articles":[{"title":"è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«","link":"URL","pubDate":"æ—¥ä»˜","guid":"ID","category":"AIé–¢é€£","summary":"è¦ç´„"}]}

    - name: Export Gemini JSON to env
      run: |
        echo "GEMINI_JSON<<EOF" >> $GITHUB_ENV
        echo '${{ steps.analyze.outputs.summary }}' >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Validate analyzed JSON
      shell: bash
      run: |
        jq -e '
          type=="object" and has("articles") and (.articles|type=="array") and
          all(.articles[]; has("title") and has("link") and has("guid") and has("summary")
            and (.category=="AIé–¢é€£" or .category=="AIä»¥å¤–"))
        ' <<< "$GEMINI_JSON" > /dev/null

    - name: Process analysis results
      id: process
      env:
        GEMINI_JSON: ${{ env.GEMINI_JSON }}
      run: node scripts/gemini-analyzer.js

    - name: Upload analyzed articles
      uses: actions/upload-artifact@v4
      with:
        name: analyzed-articles
        path: analyzed-articles.json

    - name: Analysis summary
      run: |
        echo "ğŸ¤– Gemini Analysis Results:"
        echo "   Total analyzed: ${{ steps.process.outputs.analyzed-count }}"
        echo "âœ… Ready for Discord notification job"