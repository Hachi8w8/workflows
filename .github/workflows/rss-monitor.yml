name: RSS Monitor with Gemini Analysis

on:
  # schedule:
  #   - cron: '0 * * * *'  # æ¯æ™‚0åˆ†ã«å®Ÿè¡Œï¼ˆ1æ™‚é–“é–“éš”ï¼‰
  workflow_dispatch:

concurrency:
  group: rss-monitor
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  # Job1: RSSå–å¾—ãƒ»å·®åˆ†æ¤œå‡º
  rss-trigger:
    runs-on: ubuntu-latest
    outputs:
      # æ–°ç€è¨˜äº‹ãŒã‚ã‚‹ã‹ã®çœŸå½å€¤
      has-new-articles: ${{ steps.detect-new.outputs.has-new-articles }}
      # æ–°ç€è¨˜äº‹ã®æ•°
      new-articles-count: ${{ steps.detect-new.outputs.new-articles-count }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install RSS parser
      run: npm install rss-parser

    - name: Fetch and detect new articles
      id: detect-new
      run: node scripts/rss-processor.js

    - name: Upload new articles data
      if: steps.detect-new.outputs.has-new-articles == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: new-articles
        path: new-articles.json

    - name: Upload cache file
      if: steps.detect-new.outputs.has-new-articles == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: rss-cache
        path: cache/rss-processed.json

    - name: Summary
      run: |
        echo "ğŸ” RSS Trigger Results:"
        echo "   New articles found: ${{ steps.detect-new.outputs.has-new-articles }}"
        echo "   Count: ${{ steps.detect-new.outputs.new-articles-count }}"
        if [ "${{ steps.detect-new.outputs.has-new-articles }}" = "true" ]; then
          echo "âœ… Proceeding to Gemini analysis job"
        else
          echo "â­ï¸  No new articles, skipping downstream jobs"
        fi

  # Job2: Geminiåˆ†æ + JSå‡¦ç† + Mergeï¼ˆn8nã®è¤‡æ•°ãƒãƒ¼ãƒ‰ã«å¯¾å¿œï¼‰
  gemini-analysis:
    runs-on: ubuntu-latest
    needs: rss-trigger
    if: needs.rss-trigger.outputs.has-new-articles == 'true'
    outputs:
      analyzed-count: ${{ steps.process.outputs.analyzed-count }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Download new articles data
      uses: actions/download-artifact@v4
      with:
        name: new-articles
        path: .

    - name: Analyze articles with Gemini CLI
      id: analyze
      uses: google-github-actions/run-gemini-cli@v0.1.12
      with:
        gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
        gemini_model: gemini-2.5-flash
        settings: |
          {
            "coreTools": [
              "run_shell_command(cat)"
            ],
            "output": { "format": "json" }
          }
        prompt: |
          ã‚ãªãŸã¯è¨˜äº‹ã®åˆ†é¡ã¨è¦ç´„ã‚’è¡Œã†AIã§ã™ã€‚

          1) run_shell_command(cat, "new-articles.json") ã§è¨˜äº‹é…åˆ—ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚
             å„è¦ç´ ã¯ { title, link, pubDate, content, contentSnippet, guid } ã‚’æŒã¡ã¾ã™ã€‚

          2) å„è¨˜äº‹ã”ã¨ã«ä»¥ä¸‹ã‚’è¡Œã„ã€æœ€çµ‚çš„ã« {"articles":[...]} ã® **JSONã®ã¿** ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
             - category: ã€ŒAIé–¢é€£ã€ã¾ãŸã¯ã€ŒAIä»¥å¤–ã€ã®åˆ¤å®š
               * AIé–¢é€£: äººå·¥çŸ¥èƒ½ã€æ©Ÿæ¢°å­¦ç¿’ã€æ·±å±¤å­¦ç¿’ã€ChatGPTã€Geminiã€Claudeç­‰ã®AIãƒ„ãƒ¼ãƒ«ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã§ã®AIæ´»ç”¨ã€AIé–‹ç™ºã€ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ã‚¹é–¢é€£
               * AIä»¥å¤–: ä¸Šè¨˜ä»¥å¤–ã®ã™ã¹ã¦
             - summary: æœ¬æ–‡ãƒ™ãƒ¼ã‚¹ã®æ—¥æœ¬èªè¦ç´„ï¼ˆ**content â†’ contentSnippet â†’ title ã®é †ã«å‚ç…§**ï¼‰
               * äº‹å®Ÿã«å¿ å®Ÿã«ã€2â€“3æ–‡ã€æœ€å¤§200å­—
               * èª‡å¼µã‚„æ–°è¦äº‹å®Ÿã®å‰µä½œã¯ã—ãªã„
               * å…·ä½“çš„ãªãƒˆãƒ”ãƒƒã‚¯ã‚„æ‰‹æ³•ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªåãŒã‚ã‚Œã°å«ã‚ã‚‹
             - title, link, pubDate, guid ã¯å…¥åŠ›ã®å€¤ã‚’ãã®ã¾ã¾è»¢è¨˜ã™ã‚‹

          å‡ºåŠ›ã‚¹ã‚­ãƒ¼ãƒï¼ˆå³å®ˆï¼‰:
          {
            "articles": [
              {
                "title": "string",
                "link": "string", 
                "pubDate": "string",
                "guid": "string",
                "category": "AIé–¢é€£" | "AIä»¥å¤–",
                "summary": "string"
              }
            ]
          }

    - name: Debug Gemini output
      run: |
        echo "=== Gemini CLI Analysis Results ==="
        echo "Raw summary output:"
        echo "${{ steps.analyze.outputs.summary }}"
        echo "===================="

    - name: Export Gemini JSON to env
      shell: bash
      run: |
        {
          echo "GEMINI_JSON<<EOF"
          echo '${{ steps.analyze.outputs.summary }}'
          echo "EOF"
        } >> "$GITHUB_ENV"

    - name: Debug GEMINI_JSON content
      shell: bash
      run: |
        echo "=== GEMINI_JSON environment variable content ==="
        echo "$GEMINI_JSON"
        echo "===================="
        
        echo "=== First 500 chars ==="
        echo "$GEMINI_JSON" | head -c 500
        echo "===================="

    - name: Process analysis results
      id: process
      env:
        GEMINI_JSON: ${{ env.GEMINI_JSON }}
      run: node scripts/gemini-analyzer.js

    - name: Upload analyzed articles
      uses: actions/upload-artifact@v4
      with:
        name: analyzed-articles
        path: analyzed-articles.json

    - name: Analysis summary
      run: |
        echo "ğŸ¤– Gemini Analysis Results:"
        echo "   Total analyzed: ${{ steps.process.outputs.analyzed-count }}"
        echo "âœ… Ready for Discord notification job"

  # Job3: Discordé€šçŸ¥
  discord-switch:
    runs-on: ubuntu-latest
    needs: gemini-analysis
    if: fromJSON(needs.gemini-analysis.outputs.analyzed-count) > 0
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Download analyzed articles
      uses: actions/download-artifact@v4
      with:
        name: analyzed-articles
        path: .

    - name: Send Discord notifications
      env:
        DISCORD_AI_WEBHOOK: ${{ secrets.DISCORD_AI_WEBHOOK }}
        DISCORD_OTHER_WEBHOOK: ${{ secrets.DISCORD_OTHER_WEBHOOK }}
      run: node scripts/discord-notifier.js

    - name: Discord summary
      run: |
        echo "ğŸ“¢ Discord notifications sent"
        echo "âœ… RSS monitoring workflow completed"

  # Job4: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ°¸ç¶šåŒ–
  cache-update:
    runs-on: ubuntu-latest
    needs: [discord-switch, gemini-analysis]
    if: always() && fromJSON(needs.gemini-analysis.outputs.analyzed-count) > 0
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download cache file
      uses: actions/download-artifact@v4
      with:
        name: rss-cache
        path: cache
      continue-on-error: true

    - name: Commit and push cache updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [ -f "cache/rss-processed.json" ]; then
          git add cache/rss-processed.json
          
          if git diff --staged --quiet; then
            echo "ğŸ“ No cache changes to commit"
          else
            git commit -m "update: RSS cache with new processed articles

            - Update processed article IDs cache
            - Prevent duplicate notifications

            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

            Co-Authored-By: Claude <noreply@anthropic.com>"
            git push
            echo "âœ… Cache committed and pushed"
          fi
        else
          echo "âš ï¸ Cache file not found, skipping commit"
        fi

    - name: Cache summary
      run: |
        echo "ğŸ’¾ Cache Update Results:"
        if [ -f "cache/rss-processed.json" ]; then
          echo "   Cache file: $(wc -l < cache/rss-processed.json) processed IDs"
        else
          echo "   Cache file: Not found"
        fi
        echo "ğŸ¯ RSS monitoring workflow fully completed"